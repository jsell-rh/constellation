# Understanding the `up` Metric in Constellation Dashboards

## The Issue

Both Grafana dashboards originally used `up{job="constellation"}` for the System Health gauge. However, this metric doesn't exist in Constellation's `/metrics` endpoint, leading to confusion.

## What is the `up` Metric?

The `up` metric is **NOT** exported by applications. Instead, it's automatically generated by Prometheus itself:

- `up = 1` - Prometheus successfully scraped the target
- `up = 0` - Scrape failed (target down, network issue, timeout, etc.)

This is a Prometheus convention used to track scrape success/failure.

## Why It Wasn't in /metrics

When you query `/metrics` directly:
```bash
curl http://localhost:9090/metrics | grep "^up"
# No results - because apps don't export this metric
```

The `up` metric only exists within Prometheus after it scrapes targets.

## The Solution

We've implemented a proper application-level health metric:

```typescript
// In metrics.ts
export const systemHealth = new Gauge({
  name: 'constellation_system_health',
  help: 'System health status (1=healthy, 0=unhealthy)',
  labelNames: ['component'],
});
```

This metric is updated by the health check system:
- `constellation_system_health{component="overall"}` - Overall system health
- `constellation_system_health{component="router"}` - Router health
- `constellation_system_health{component="ai-client"}` - AI client health
- etc.

## Dashboard Updates

Both dashboards have been updated:
```diff
- "expr": "up{job=\"constellation\"}"
+ "expr": "constellation_system_health{component=\"overall\"}"
```

## Using Both Metrics

For comprehensive monitoring, you can use both:

1. **`up` metric** (in Prometheus)
   - Shows if Prometheus can reach Constellation
   - Useful for network/connectivity issues
   - Requires Prometheus scrape configuration

2. **`constellation_system_health` metric**
   - Shows application-level health
   - Includes component-level details
   - Available directly from `/metrics`

## Prometheus Configuration

If you want to use the `up` metric, configure Prometheus:

```yaml
scrape_configs:
  - job_name: 'constellation'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 30s
    metrics_path: '/metrics'
```

Then `up{job="constellation"}` will be available in Prometheus (not in `/metrics`).

## Best Practice

Use `constellation_system_health{component="overall"}` for application health monitoring. It provides:
- Direct visibility from the app
- Component-level granularity
- No dependency on Prometheus scraping
- Consistent with other Constellation metrics
